<!DOCTYPE html>
<html lang="en">
  <%- include('./components/head') %>
    <body>
      <!-- Mobile Toggle Button -->
      <button class="mobile-toggle" onclick="document.getElementById('sidebar').classList.toggle('active')">
          <i class="mdi mdi-menu"></i>
      </button>

      <script src="https://www.google.com/recaptcha/api.js" async defer></script>
      <div class="container-scroller">
        <!-- partial:partials/_sidebar.html -->
      <%- include('./components/sidebar') %>
        <!-- partial -->
        <div class="container-fluid page-body-wrapper">
          <!-- partial -->
        <div class="main-panel">
          <div class="content-wrapper">

           <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
                <div>
                    <h2 class="mb-1" style="font-weight: 700; letter-spacing: -0.025em; font-size: 1.8rem;">Linkvertise</h2>
                    <p class="text-gray mb-0">Complete short links to earn free coins.</p>
                </div>
            </div>

            <% if (req.query.err) { %>
              <div class="alert fade show mb-4" role="alert" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); color: #f87171; border-radius: var(--radius);">
                  <% if (req.query.err == "MUSTCOMPLETECAPTCHA") { %>
                    <div class="d-flex align-items-center"><i class="mdi mdi-alert-circle mr-2"></i>You must complete the captcha to prove you are human!</div>
                <% } else if (req.query.err == "INVALIDCAPTCHARESPONSE") { %>
                    <div class="d-flex align-items-center"><i class="mdi mdi-alert-circle mr-2"></i>You submitted an invalid captcha response, try again.</div>
                <% } %>
              </div>
            <% } %>
            <% if (req.query.success) { %>
              <div class="alert fade show mb-4" role="alert" style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2); color: #34d399; border-radius: var(--radius);">
                <div class="d-flex align-items-center"><i class="mdi mdi-check-circle mr-2"></i>Success! <%= settings.linkvertise.coins%> coins were added to your account.</div>
            </div>
            <% } %>

              <div class="row">
                <div class="col-md-8 grid-margin stretch-card">
                    <div class="card" style="background: var(--card); border: 1px solid var(--border);">
                        
                    <div class="card-body text-center py-5" style="display: none;" id="generate-panel">
                        <div style="background: rgba(245, 158, 11, 0.1); width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem auto;">
                            <i class="mdi mdi-link-variant" style="font-size: 2.5rem; color: #f59e0b;"></i>
                        </div>
                        <h4 class="mb-3">Earn Coins</h4>
                        <p class="text-gray mb-4">Complete a Linkvertise link to instantly earn <span class="text-white font-weight-bold"><%= settings.linkvertise.coins%> coins</span>.</p>
                        <button class="btn btn-primary btn-lg" onclick="generate()">
                            <i class="mdi mdi-play mr-2"></i> Generate Link
                        </button>
                    </div>

                    <div class="card-body text-center py-5" id="loading-panel">
                        <div class="spinner-border text-primary mb-3" role="status"></div>
                        <h3>Loading...</h3>
                    </div>

                    <div class="card-body text-center py-5" id="error-panel" style="display: none;">
                      <i class="mdi mdi-alert-circle-outline text-danger mb-3" style="font-size: 3rem;"></i>
                      <h3>An error occured!</h3>
                      <p class="text-gray">Please refresh the page and try again.</p>
                    </div>

                    <div class="card-body text-center py-5" id="cooldown-panel" style="display: none;">
                        <div style="background: rgba(59, 130, 246, 0.1); width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem auto;">
                            <i class="mdi mdi-timer-sand" style="font-size: 2.5rem; color: #3b82f6;"></i>
                        </div>
                        <h3>Cooldown Active</h3>
                        <p class="text-gray">Please wait <span id="cooldown-seconds" class="font-weight-bold text-white"></span> seconds before generating another link.</p>
                    </div>

                    <div class="card-body text-center py-5" id="dailylimit-panel" style="display: none;">
                      <div style="background: rgba(239, 68, 68, 0.1); width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem auto;">
                            <i class="mdi mdi-calendar-clock" style="font-size: 2.5rem; color: #f87171;"></i>
                        </div>
                        <h3>Daily Limit Reached</h3>
                        <p class="text-gray">You can complete more links after <span id="daily-timeleft" class="font-weight-bold text-white"></span>.</p>
                    </div>

                    <script type="text/javascript">
                      const loadingPanel = document.getElementById('loading-panel')
                      fetch(`/api/lvcooldown`).then(res => res.json())
                      .then(json => {
                        if (json.cooldown === null) {
                          const genPanel = document.getElementById('generate-panel')
                          loadingPanel.style.display = 'none'
                          return genPanel.style.display = ''
                        } else if (json.dailyLimit) {
                          const dailyPanel = document.getElementById('dailylimit-panel')
                          dailyPanel.style.display = ''
                          loadingPanel.style.display = 'none'
                          const timeLeft = document.getElementById('daily-timeleft')
                          timeLeft.innerHTML = json.readable
                        } else if (json.error) {
                          const errorPanel = document.getElementById('error-panel')
                          loadingPanel.style.display = 'none'
                          errorPanel.style.display = ''
                        } else {
                          loadingPanel.style.display = 'none'
                          const cooldownPanel = document.getElementById('cooldown-panel')
                          const cooldownTimer = document.getElementById('cooldown-seconds')

                          setInterval(() => {
                            const timeLeft = json.cooldown - Date.now()
                            if (timeLeft < 0) return window.location.replace('/lv')
                            cooldownTimer.innerHTML = Math.floor(timeLeft / 1000)
                          }, 1000)

                          cooldownPanel.style.display = ''
                        }
                      })
                      .catch(() => {
                        loadingPanel.style.display = 'none'
                        const errorPanel = document.getElementById('error-panel')
                        errorPanel.style.display = ''
                      })
                    </script>
                  <script type="text/javascript">
                    function generate() {
                      window.location.replace(`/lv/gen`)
                    }
                  </script>
              </div>
            </div>
            </div></div>
            <!-- content-wrapper ends -->
          <%- include('./components/footer') %>
          </div>
          <!-- main-panel ends -->
        </div>
        <!-- page-body-wrapper ends -->
      </div>
      <!-- container-scroller -->
      <%- include('./components/scripts') %>
    </body>
  </html>